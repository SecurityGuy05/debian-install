### --- Locale, keyboard, time ---
d-i debian-installer/locale string en_US.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select us
d-i time/zone string America/Chicago
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

### --- Networking (DHCP on any NIC) ---
d-i netcfg/choose_interface select auto
d-i netcfg/disable_dhcp boolean false
d-i netcfg/get_hostname string wyse
d-i netcfg/get_domain string local

### --- Mirrors & APT (non-free-firmware for Wi-Fi/BT on tiny boxes) ---
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/non-free-firmware boolean true
# Don’t keep the CD entry around after install
d-i apt-setup/disable-cdrom-entries boolean true

### --- Users & passwords (use SHA-512 hashes!) ---
# Generate with:  mkpasswd -m sha-512
# EXAMPLES/PLACEHOLDERS — replace these two lines with your own hashes:
d-i passwd/root-password-crypted password $6$YwxiSC4oN.R2S.W7$xKpltT1DMt1.c1/m3ELo2h9vVOiYL6/tS8HOkIJQy67dXxatvBgcoMJmbhahZqFKJ8NILUpcgfLoiJ4HNx1qZ/
d-i passwd/user-fullname string paladin
d-i passwd/username string paladin
d-i passwd/user-password-crypted password $6$YwxiSC4oN.R2S.W7$xKpltT1DMt1.c1/m3ELo2h9vVOiYL6/tS8HOkIJQy67dXxatvBgcoMJmbhahZqFKJ8NILUpcgfLoiJ4HNx1qZ/
d-i user-setup/allow-password-weak boolean false
d-i user-setup/encrypt-home boolean false
d-i passwd/root-login boolean true

### --- Partitioning on /dev/mmcblk0: EFI 626M, / 5.9G, swap 754M ---

# Wipe and use GPT on the eMMC
d-i partman-auto/disk string /dev/mmcblk0
d-i partman-partitioning/choose_label string gpt
d-i partman-partitioning/default_label string gpt
d-i partman-auto/method string regular

# Custom expert recipe with fixed sizes (values are in MB)
d-i partman-auto/expert_recipe string                                \
  mmc-fixed ::                                                       \
    626 626 626 fat32                                                \
      $primary{ } $iflabel{ gpt } $reusemethod{ }                    \
      method{ efi } format{ }                                        \
      label{ EFI System Partition }                                  \
      mountpoint{ /boot/efi }                                        \
    .                                                                \
    5900 5900 5900 ext4                                              \
      $primary{ } $bootable{ }                                       \
      method{ format } format{ } use_filesystem{ } filesystem{ ext4 }\
      label{ root } mountpoint{ / }                                  \
    .                                                                \
    754 754 754 linux-swap                                           \
      $primary{ } method{ swap } format{ }                           \
      label{ swap }                                                  \
    .

# Use our recipe and don’t prompt
d-i partman-auto/choose_recipe select mmc-fixed
d-i partman/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Make sure GRUB lands correctly
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/mmcblk0

### --- Package selection (install what your script expects) ---
tasksel tasksel/first multiselect standard
d-i pkgsel/include string systemd sysvinit-utils nano curl wget ca-certificates ufw systemd-zram-generator unattended-upgrades openssh-server
d-i pkgsel/upgrade select none
popularity-contest popularity-contest/participate boolean false

### --- Bootloader ---
# Most Wyse boxes are UEFI; Debian installer will pick grub-efi-amd64 automatically.
# If yours has a 32-bit UEFI, you’ll need grub-efi-ia32; consider a custom image.
d-i grub-installer/only_debian boolean true
d-i grub-installer/skip boolean false

### --- Finish & run our post-install script ---
# Option A: fetch over HTTP
# d-i preseed/late_command string \
#   in-target /bin/bash -c "curl -fsSL http://YOUR-SERVER/postinstall.sh -o /root/postinstall.sh && chmod +x /root/postinstall.sh && /bin/bash /root/postinstall.sh"

# Option B: embed the script content from the USB preseed (shown below)
# We write it into /target and execute it chrooted (in-target).
d-i preseed/late_command string \
  cp /cdrom/postinstall.sh /target/root/postinstall.sh; \
  in-target chmod +x /root/postinstall.sh; \
  in-target /bin/bash /root/postinstall.sh

### --- Autoreboot on success ---
d-i finish-install/reboot_in_progress note
