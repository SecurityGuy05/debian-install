### --- Locale, keyboard, time ---
d-i debian-installer/locale string en_US.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select us
d-i time/zone string America/Chicago
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

### --- Networking (DHCP on any NIC) ---
d-i netcfg/choose_interface select auto
d-i netcfg/disable_dhcp boolean false
d-i netcfg/get_hostname string wyse
d-i netcfg/get_domain string local

### --- Mirrors & APT (non-free-firmware for Wi-Fi/BT on tiny boxes) ---
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/non-free-firmware boolean true
# Don’t keep the CD entry around after install
d-i apt-setup/disable-cdrom-entries boolean true

### --- Users & passwords (use SHA-512 hashes!) ---
# Generate with:  mkpasswd -m sha-512
# EXAMPLES/PLACEHOLDERS — replace these two lines with your own hashes:
# Enable root login
d-i passwd/root-login boolean true
# Root password (use a unique hash generated with mkpasswd)
d-i passwd/root-password-crypted password $6$uhfG7wNhh//gJGcU$C0PT4nt/rJ/oo8.0AMZTYX8/pp5d/wCdkCW5bmAzWVX2tPafQFTf3j4P6w13un.ybASBCzaOpzgY7fa/NHYq40

# Set up the paladin user
d-i passwd/user-fullname string Paladin User
d-i passwd/username string paladin
# User password (use a different hash from root)
d-i passwd/user-password-crypted password $6$uhfG7wNhh//gJGcU$C0PT4nt/rJ/oo8.0AMZTYX8/pp5d/wCdkCW5bmAzWVX2tPafQFTf3j4P6w13un.ybASBCzaOpzgY7fa/NHYq40
d-i passwd/user-uid string 1000
d-i passwd/user-default-groups string sudo audio cdrom dip floppy video plugdev netdev bluetooth
# Enforce stronger passwords (optional, recommended for production)
d-i user-setup/allow-password-weak boolean false
# Disable home directory encryption
d-i user-setup/encrypt-home boolean false


### --- Partitioning on /dev/mmcblk0: EFI 626M, / 5.9G, swap 754M ---

# Wipe and use GPT on the eMMC
d-i partman-auto/disk string /dev/mmcblk0
d-i partman-partitioning/choose_label string gpt
d-i partman-partitioning/default_label string gpt
d-i partman-auto/method string regular

# Custom expert recipe with fixed sizes (values are in MB)
d-i partman-auto/expert_recipe string                                \
  mmc-fixed ::                                                       \
    626 626 626 fat32                                                \
      $primary{ } $iflabel{ gpt } $reusemethod{ }                    \
      method{ efi } format{ }                                        \
      label{ EFI System Partition }                                  \
      mountpoint{ /boot/efi }                                        \
    .                                                                \
    5900 5900 5900 ext4                                              \
      $primary{ } $bootable{ }                                       \
      method{ format } format{ } use_filesystem{ } filesystem{ ext4 }\
      label{ root } mountpoint{ / }                                  \
    .                                                                \
    754 754 754 linux-swap                                           \
      $primary{ } method{ swap } format{ }                           \
      label{ swap }                                                  \
    .

# Use our recipe and don’t prompt
d-i partman-auto/choose_recipe select mmc-fixed
d-i partman/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Make sure GRUB lands correctly
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/mmcblk0

### Package selection
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server sudo curl wget vim
d-i pkgsel/upgrade select none
popularity-contest popularity-contest/participate boolean false

### --- Bootloader ---
# Most Wyse boxes are UEFI; Debian installer will pick grub-efi-amd64 automatically.
# If yours has a 32-bit UEFI, you’ll need grub-efi-ia32; consider a custom image.
d-i grub-installer/only_debian boolean true
d-i grub-installer/skip boolean false

### Post-install: fetch from GitHub, fix CRLF, run with log
d-i preseed/late_command string \
  in-target sh -c " \
    (apt-get update >/dev/null 2>&1 || true); \
    (apt-get install -y curl ca-certificates >/dev/null 2>&1 || true); \
    curl -fsSL https://raw.githubusercontent.com/SecurityGuy05/debian-install/main/postinstall.sh -o /root/postinstall.sh && \
    sed -i 's/\r$//' /root/postinstall.sh && \
    chmod +x /root/postinstall.sh && \
    /bin/bash -eux /root/postinstall.sh > /root/postinstall.log 2>&1"


### --- Autoreboot on success ---
d-i finish-install/reboot_in_progress note
